name: AI Code Quality Gate

on:
  pull_request:
    branches: [main, develop]
  push:
    branches: [main, develop]

jobs:
  # Soft Mode: PR comments only, never fails
  quality-check-soft:
    name: Quality Check (Soft Mode)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install AI SLOP Detector
        run: |
          pip install ai-slop-detector

      - name: Run Quality Analysis (Soft Mode)
        id: quality_check
        run: |
          slop-detector --project . --ci-mode soft --ci-report > gate_report.md
          echo "REPORT<<EOF" >> $GITHUB_OUTPUT
          cat gate_report.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
        continue-on-error: true

      - name: Comment PR with Report
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const report = `${{ steps.quality_check.outputs.REPORT }}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

  # Hard Mode: Fail build on critical issues
  quality-gate-hard:
    name: Quality Gate (Hard Mode)
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && github.ref == 'refs/heads/main'

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install AI SLOP Detector
        run: |
          pip install ai-slop-detector

      - name: Run Quality Gate (Hard Mode)
        run: |
          slop-detector --project . --ci-mode hard --ci-report

      - name: Upload Report on Failure
        if: failure()
        uses: actions/upload-artifact@v3
        with:
          name: quality-gate-report
          path: gate_report.md

  # Quarantine Mode: Track repeat offenders
  quality-gate-quarantine:
    name: Quality Gate (Quarantine Mode)
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Need full history for quarantine tracking

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'

      - name: Install AI SLOP Detector
        run: |
          pip install ai-slop-detector

      - name: Restore Quarantine Database
        uses: actions/cache@v3
        with:
          path: .slop_quarantine.json
          key: slop-quarantine-${{ github.repository }}

      - name: Run Quality Gate (Quarantine Mode)
        id: quarantine_check
        run: |
          slop-detector --project . --ci-mode quarantine --ci-report > gate_report.md
          EXIT_CODE=$?
          echo "REPORT<<EOF" >> $GITHUB_OUTPUT
          cat gate_report.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          exit $EXIT_CODE

      - name: Save Quarantine Database
        if: always()
        uses: actions/cache/save@v3
        with:
          path: .slop_quarantine.json
          key: slop-quarantine-${{ github.repository }}-${{ github.run_id }}

      - name: Comment PR with Quarantine Report
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const report = `${{ steps.quarantine_check.outputs.REPORT }}`;
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: report
            });

      - name: Fail if Escalated
        if: steps.quarantine_check.outcome == 'failure'
        run: exit 1
